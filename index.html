<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Private Dialer</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="app-container">
    <div id="permission-screen" style="padding: 30px; text-align: center; background: white; height: 100%;">
        <i class="fas fa-shield-alt" style="font-size: 4rem; color: #1565C0; margin-top: 50px;"></i>
        <h2 style="margin-top: 20px;">طلب إذن</h2>
        <p>يرجى منح إذن الميكروفون للمتابعة</p>
        <button onclick="window.requestRealPermissions()" style="background: #1565C0; color: white; padding: 15px 30px; border-radius: 30px; border: none; margin-top: 30px;">ابدأ الآن</button>
    </div>

    <div id="login-screen" class="hidden">
        <div class="login-logo"><i class="fas fa-phone-alt"></i></div>
        <h2>تسجيل الدخول</h2>
        <div style="margin-top: 20px;">
            <input type="checkbox" id="terms-checkbox"> <span>أوافق على الشروط</span>
        </div>
        <button class="login-btn" onclick="window.firebaseAuth.login()">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
            Sign in with Google
        </button>
    </div>

    <div id="main-app" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
        <div id="screen-keypad" class="page active">
            <div id="balance-display" style="color: #1565C0; font-weight: bold; margin-bottom: 10px;">$0.00</div>
            <div id="dial-display" class="dial-display"></div>
            <div class="keypad-grid">
                <button class="key-btn" onclick="window.dial('1')">1</button>
                <button class="key-btn" onclick="window.dial('2')">2</button>
                <button class="key-btn" onclick="window.dial('3')">3</button>
                <button class="key-btn" onclick="window.dial('4')">4</button>
                <button class="key-btn" onclick="window.dial('5')">5</button>
                <button class="key-btn" onclick="window.dial('6')">6</button>
                <button class="key-btn" onclick="window.dial('7')">7</button>
                <button class="key-btn" onclick="window.dial('8')">8</button>
                <button class="key-btn" onclick="window.dial('9')">9</button>
                <button class="key-btn" onclick="window.dial('*')">*</button>
                <button class="key-btn" onclick="window.dial('0')">0</button>
                <button class="key-btn" onclick="window.dial('#')">#</button>
            </div>
            <div style="margin-top: 30px;">
                <button onclick="window.makeRealCall()" style="background: #4CAF50; color: white; width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 1.5rem;"><i class="fas fa-phone"></i></button>
                <button onclick="window.deleteDigit()" style="margin-right: 20px; border: none; background: none; font-size: 1.5rem;"><i class="fas fa-backspace"></i></button>
            </div>
        </div>

        <div id="screen-active-call">
            <h2 id="call-number"></h2>
            <div id="timer" class="caller-timer">00:00</div>
            <button onclick="window.hangUp()" class="end-call-btn"><i class="fas fa-phone-slash"></i></button>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active"><i class="fas fa-th"></i></div>
            <div class="nav-item"><i class="fas fa-user"></i></div>
        </nav>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD8hrO2kX1zXaA46PImzMGqOt4iTwhXKI0",
        authDomain: "call-now-24582.firebaseapp.com",
        projectId: "call-now-24582",
        storageBucket: "call-now-24582.firebasestorage.app",
        messagingSenderId: "982107544824",
        appId: "1:982107544824:web:c5b6806042ba44ff896f0d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.requestRealPermissions = async () => {
        try {
            await navigator.mediaDevices.getUserMedia({ audio: true });
            document.getElementById('permission-screen').classList.add('hidden');
            onAuthStateChanged(auth, (user) => {
                if (user) setupUser(user);
                else document.getElementById('login-screen').classList.remove('hidden');
            });
        } catch (e) { alert("يجب منح إذن الميكروفون"); }
    };

    window.firebaseAuth = {
        login: () => {
            if(!document.getElementById('terms-checkbox').checked) return alert("وافق على الشروط");
            signInWithPopup(auth, new GoogleAuthProvider()).then(res => setupUser(res.user));
        }
    };

    function setupUser(user) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        onSnapshot(doc(db, "users", user.uid), (s) => {
            if(s.exists()) document.getElementById('balance-display').innerText = `$${s.data().balance.toFixed(2)}`;
            else setDoc(doc(db, "users", user.uid), { balance: 1.00 });
        });
    }

    window.dial = (n) => document.getElementById('dial-display').innerText += n;
    window.deleteDigit = () => document.getElementById('dial-display').innerText = document.getElementById('dial-display').innerText.slice(0, -1);
    window.makeRealCall = () => document.getElementById('screen-active-call').classList.add('active');
    window.hangUp = () => document.getElementById('screen-active-call').classList.remove('active');
</script>
</body>
</html>
